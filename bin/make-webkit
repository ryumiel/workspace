#!/usr/bin/env python

from build_config import ConfigHelper
from datetime import timedelta
from subprocess import call
from subprocess import check_output
import atexit
import multiprocessing
import os.path
import subprocess
import sys
import time

startTime = time.time()
config_helper = ConfigHelper()

def ensureBuildDir(options):
    target_dir = config_helper.get_webkit_dir(options)

    if target_dir is None:
      print "Error: Invalid build dir"
      sys.exit(2)

    if not os.path.exists(target_dir):
        os.makedirs(target_dir)
    return target_dir

def jhbuildCmd():
    return ["jhbuild", "-f", config_helper.jhbuildrc, "run"]

def runCMake(options):
    working_dir = ensureBuildDir(options)
    os.chdir(working_dir)

    if options.wpe:
      cmakeargs = ["-DPORT=WPE", "-GNinja", "-DDEVELOPER_MODE=ON"]
      webkit_src_dir = os.path.join(config_helper.workspace_dir, 'WebKitWPE/')
    else:
      cmakeargs = ["-DPORT=GTK", "-GNinja", "-DDEVELOPER_MODE=ON"]
      webkit_src_dir = os.path.join(config_helper.workspace_dir, 'WebKitGtk/')

    if options.disable_threaded_compositor:
      cmakeargs.append("-DENABLE_THREADED_COMPOSITOR=OFF")
    elif not options.disable_threaded_compositor:
      cmakeargs.append("-DENABLE_THREADED_COMPOSITOR=ON")

    if options.use_gles:
      cmakeargs.append("-DENABLE_GLES2=ON")
      cmakeargs.append("-DENABLE_ACCELERATED_2D_CANVAS=OFF")
    elif not options.use_gles:
      cmakeargs.append("-DENABLE_GLES2=OFF")
      cmakeargs.append("-DENABLE_ACCELERATED_2D_CANVAS=ON")

    if options.disable_gstgl:
      cmakeargs.append("-DUSE_GSTREAMER_GL=OFF")
    elif not options.disable_gstgl:
      cmakeargs.append("-DUSE_GSTREAMER_GL=ON")

    if options.debug:
        cmakeargs.append("-DCMAKE_BUILD_TYPE=Debug")
        cmakeargs.append("-DDEBUG_FISSION=ON")
    else:
        cmakeargs.append("-DCMAKE_BUILD_TYPE=Release")
        cmakeargs.append("-DDEBUG_FISSION=OFF")

    cmakeargs.append("-DCMAKE_EXPORT_COMPILE_COMMANDS=ON")
    #cmakeargs.append("-DUSE_REDIRECTED_XCOMPOSITE_WINDOW=OFF")

    cmakeargs.append("-DCMAKE_INSTALL_PREFIX=" + config_helper.install_dir)
    cmakeargs.append("-DCMAKE_INSTALL_LIBDIR=lib")

    cmakeCommand = jhbuildCmd() + ["cmake", webkit_src_dir] + cmakeargs
    call(cmakeCommand)

def installWebKitGtk(options):
    working_dir = ensureBuildDir(options)
    os.chdir(working_dir)
    installCommand = jhbuildCmd() + ["cmake", "-P", working_dir + '/cmake_install.cmake']
    call(installCommand)

def buildWebKitGtk(options):
    try:
      iceccd_active_status = check_output(["/usr/bin/systemctl", "is-active", "iceccd.service"]).rstrip();
    except subprocess.CalledProcessError, e:
      iceccd_active_status = "unknown"

    print iceccd_active_status
    if iceccd_active_status == "active":
      isIceccdActive = True
    elif iceccd_active_status == "unknown":
      isIceccdActive = False
    else:
      print "Error: Cannot determine the status of iceccd"
      exit(0)

    set_build_environment(False, isIceccdActive)
    if isIceccdActive:
      numOfJob = 37
    else:
      numOfJob = multiprocessing.cpu_count()

    runCMake(options)
    working_dir = ensureBuildDir(options)
    os.chdir(working_dir)

    buildCommand = jhbuildCmd() + ["ninja-build", "-j" + str(numOfJob)]

    build_start_time = time.time()
    build_return = call(buildCommand)
    build_time = round(time.time() - build_start_time)
    print "WebKit build dir: " + working_dir
    print "WebKit build options --"
    print options
    print "Elapsed build time: " + str(timedelta(seconds=build_time))
    if build_return == 0:
      return True
    return False

def buildFinished():
    elapsedTime = round(time.time() - startTime)
    if elapsedTime > 30:
      call(["/usr/bin/aplay", "-q", config_helper.build_finished_sound_file])

def set_build_environment(isClang, isIcecc):
    if isClang:
      os.environ["CC"]="clang"
      os.environ["CXX"]="clang++"
      os.environ["CCACHE_CPP2"]="yes"

    if isIcecc:
      os.environ["CCACHE_PREFIX"]="icecc"
      os.environ["CCACHE_DISABLE"]="1"
      if isClang:
        os.environ["ICECC_VERSION"]=config_helper.config['icecc_clang_version']
      else:
        os.environ["ICECC_VERSION"]=config_helper.config['icecc_gcc_version']

def main(argv):
    argParser = config_helper.get_argument_parser()
    options = argParser.parse_args()
    atexit.register(buildFinished)
    failed_options = []

    if options.all:
      total_build_start_time = time.time()
      for option in config_helper.all_possible_build_options():
        did_success = buildWebKitGtk(option)
        if not did_success:
          failed_options.append(option)
      total_build_time = round(time.time() - total_build_start_time)
      print "Elapsed total build time: " + str(timedelta(seconds=total_build_time))
    else:
      did_success = buildWebKitGtk(options)
      if not did_success:
        failed_options.append(options)

    for option in failed_options:
      print "Build Failed: " + str(option)

    if options.install:
      installWebKitGtk(options)


if __name__ == '__main__':
    main(sys.argv)


