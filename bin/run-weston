#!/usr/bin/env python

from build_config import ConfigHelper
from subprocess import call
from subprocess import check_output
import argparse
import os
import sys

def main(argv):
  config_helper = ConfigHelper()
  argParser = argparse.ArgumentParser(description='Weston script using custom jhbuild env')
  argParser.add_argument('--llvmpipe', action='store_true', default=False, help='Use llvmpipe as a gl backend (default: False)')
  option = argParser.parse_args()

  environment = os.environ
  if option.llvmpipe:
    config_helper.set_llvmpipe_env(os.environ)

  config_helper.set_weston_env_for_server(environment)

  ret = check_output(["gsettings", "get", "org.gnome.desktop.interface", "scaling-factor"])
  scale = [int(s) for s in ret.split() if s.isdigit()][0]

  jhbuild_cmd = ['jhbuild', '-f', config_helper.jhbuildrc, 'run', 'weston', '--socket=' + config_helper.wayland_socket, '--use-pixman', '--width=1080', '--height=768', '--scale=' + str(scale)]
  call(jhbuild_cmd, env=environment)

if __name__ == '__main__':
  main(sys.argv)
